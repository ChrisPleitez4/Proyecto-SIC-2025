{% extends "base.html" %}
{% block title %}Transacciones{% endblock %}

{% block content %}
<div class="container mt-4">

  <!-- Formulario para crear transacción -->
  <div class="card mb-4 p-3">
    <h4>Registrar Transacción</h4>
    <form method="POST">
      {% csrf_token %}
      <div class="mb-3">
        {{ transaccion_form.descripcion.label_tag }}
        {{ transaccion_form.descripcion }}
        {% for error in transaccion_form.descripcion.errors %}
          <div class="text-danger small mt-1">{{ error }}</div>
        {% endfor %}
      </div>
      <div class="mb-3">
        {{ transaccion_form.fecha.label_tag }}
        {{ transaccion_form.fecha }}
        {% for error in transaccion_form.fecha.errors %}
          <div class="text-danger small mt-1">{{ error }}</div>
        {% endfor %}
      </div>
      <div class="mb-3">
        {{ transaccion_form.monto.label_tag }}
        {{ transaccion_form.monto }}
        {% for error in transaccion_form.monto.errors %}
          <div class="text-danger small mt-1">{{ error }}</div>
        {% endfor %}
      </div>
      <button type="submit" name="crear_transaccion" class="btn btn-primary mt-2">Guardar Transacción</button>
    </form>
  </div>


    <!-- Mensaje de éxito -->
  {% if mensaje_exito %}
  <div class="alert alert-success alert-dismissible fade show text-center" role="alert">
    {{ mensaje_exito }}
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
  </div>
  {% endif %}
  <!-- Lista de transacciones -->
  <h4>Transacciones Registradas</h4>
  <table class="table table-striped">
    <thead>
      <tr>
        <th>ID</th>
        <th>Descripción</th>
        <th>Monto</th>
        <th>Fecha</th>
        <th>Acciones</th>
      </tr>
    </thead>
    <tbody>
      {% for t in page_obj %}
      <tr>
        <td>{{ t.id }}</td>
        <td>{{ t.descripcion }}</td>
        <td>${{ t.monto }}</td>
        <td>{{ t.fecha|date:"d/m/Y" }}</td>
        <td>
          <button class="btn btn-sm btn-success" data-bs-toggle="modal" data-bs-target="#modalMovimiento{{ t.id }}">
            Añadir Movimiento
          </button>
        </td>
      </tr>

       <!-- Modal del movimiento para esta transacción -->
    <div class="modal fade" id="modalMovimiento{{ t.id }}" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content">
          <form method="POST">
            {% csrf_token %}
            <input type="hidden" name="transaccion_id" value="{{ t.id }}">
            <div class="modal-header">
              <h5 class="modal-title">Agregar Movimiento a {{ t.descripcion }}</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">

              <!-- Campo cuenta -->
              <div class="mb-3">
                <label for="id_cuenta_{{ t.id }}" class="form-label">Cuenta</label>
                <select name="cuenta" id="id_cuenta_{{ t.id }}" class="form-select">
                  {% for c in movimiento_form.fields.cuenta.queryset %}
                    <option value="{{ c.id }}">{{ c.codCuenta }} - {{ c.nombreCuenta }}</option>
                  {% endfor %}
                </select>
                {% if movimiento_form.errors.cuenta %}
                  <div class="text-danger small">{{ movimiento_form.errors.cuenta.0 }}</div>
                {% endif %}
              </div>

              <!-- Campo monto -->
              <div class="mb-3">
                <label for="id_monto_{{ t.id }}" class="form-label">Monto</label>
                <input type="number" step="0.01" name="monto" id="id_monto_{{ t.id }}" class="form-control">
                {% if movimiento_form.errors.monto %}
                  <div class="text-danger small">{{ movimiento_form.errors.monto.0 }}</div>
                {% endif %}
              </div>

              <!-- Campo tipo -->
              <div class="mb-3">
                <label for="id_tipo_{{ t.id }}" class="form-label">Tipo</label>
                <select name="tipo" id="id_tipo_{{ t.id }}" class="form-select">
                  {% for val, label in movimiento_form.fields.tipo.choices %}
                    <option value="{{ val }}">{{ label }}</option>
                  {% endfor %}
                </select>
                {% if movimiento_form.errors.tipo %}
                  <div class="text-danger small">{{ movimiento_form.errors.tipo.0 }}</div>
                {% endif %}
              </div>

            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
              <button type="submit" name="agregar_movimiento" class="btn btn-primary">Guardar Movimiento</button>
            </div>
          </form>
        </div>
      </div>
    </div>
      {% endfor %}
    </tbody>
  </table>

  <!-- Paginación -->
  <nav aria-label="Page navigation">
    <ul class="pagination">
      {% if page_obj.has_previous %}
        <li class="page-item">
          <a class="page-link" href="?page={{ page_obj.previous_page_number }}">Anterior</a>
        </li>
      {% else %}
        <li class="page-item disabled"><span class="page-link">Anterior</span></li>
      {% endif %}

      {% for num in page_obj.paginator.page_range %}
        <li class="page-item {% if page_obj.number == num %}active{% endif %}">
          <a class="page-link" href="?page={{ num }}">{{ num }}</a>
        </li>
      {% endfor %}

      {% if page_obj.has_next %}
        <li class="page-item">
          <a class="page-link" href="?page={{ page_obj.next_page_number }}">Siguiente</a>
        </li>
      {% else %}
        <li class="page-item disabled"><span class="page-link">Siguiente</span></li>
      {% endif %}
    </ul>
  </nav>

</div>

{% if mostrar_modal_movimiento %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    var modalEl = document.getElementById('modalMovimiento{{ mostrar_modal_movimiento }}');
    if(modalEl) {
        var modal = new bootstrap.Modal(modalEl);
        modal.show();
    }
});
</script>
{% endif %}

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Reiniciar el formulario cuando se cierre un modal
    var modals = document.querySelectorAll('.modal');
    modals.forEach(function(m) {
        m.addEventListener('hidden.bs.modal', function () {
            var form = m.querySelector('form');
            if (form) form.reset();
        });
    });
});
</script>
{% endblock %}

{% extends "base.html" %}
{% block title %}Transacciones{% endblock %}

{% block content %}
<div class="container mt-4">

  <!-- Formulario para crear transacción -->
  <div class="card mb-4 p-3">
    <h4>Registrar Transacción</h4>
    <form method="POST">
      {% csrf_token %}

      <!-- Descripción -->
      <div class="mb-3">
        {{ transaccion_form.descripcion.label_tag }}
        {{ transaccion_form.descripcion }}
        {% for error in transaccion_form.descripcion.errors %}
          <div class="text-danger small mt-1">{{ error }}</div>
        {% endfor %}
      </div>

      <!-- Fecha -->
      <div class="mb-3">
        {{ transaccion_form.fecha.label_tag }}
        {{ transaccion_form.fecha }}
        {% for error in transaccion_form.fecha.errors %}
          <div class="text-danger small mt-1">{{ error }}</div>
        {% endfor %}
      </div>

      <!-- Monto -->
      <div class="mb-3">
        {{ transaccion_form.monto.label_tag }}
        {{ transaccion_form.monto }}
        {% for error in transaccion_form.monto.errors %}
          <div class="text-danger small mt-1">{{ error }}</div>
        {% endfor %}
      </div>

      <button type="submit" name="crear_transaccion" class="btn btn-primary mt-2">Guardar Transacción</button>
    </form>
  </div>

  <!-- Lista de transacciones -->
  <h4>Transacciones Registradas</h4>
  <ul class="list-group">
    {% for t in transacciones %}
    <li class="list-group-item d-flex justify-content-between align-items-center">
      {{ t.descripcion }} - ${{ t.monto }} - {{ t.fecha|date:"d/m/Y" }}

      <!-- Botón para abrir modal de movimiento -->
      <button class="btn btn-sm btn-success" data-bs-toggle="modal" data-bs-target="#modalMovimiento{{ t.id }}">
        Añadir Movimiento
      </button>

      <!-- Modal para agregar movimiento -->
      <div class="modal fade" id="modalMovimiento{{ t.id }}" tabindex="-1">
        <div class="modal-dialog">
          <div class="modal-content">
            <form method="POST">
              {% csrf_token %}
              <input type="hidden" name="transaccion_id" value="{{ t.id }}">

              <div class="modal-header">
                <h5 class="modal-title">Agregar Movimiento a {{ t.descripcion }}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
              </div>

              <div class="modal-body">
                <!-- Campo cuenta -->
                <div class="mb-3">
                  <label for="id_cuenta_{{ t.id }}" class="form-label">Cuenta</label>
                  <select name="cuenta" id="id_cuenta_{{ t.id }}" class="form-select">
                    {% for c in movimiento_form.fields.cuenta.queryset %}
                      <option value="{{ c.id }}">{{ c.nombreCuenta }}</option>
                    {% endfor %}
                  </select>
                </div>

                <!-- Campo monto -->
                <div class="mb-3">
                  <label for="id_monto_{{ t.id }}" class="form-label">Monto</label>
                  <input type="number" step="0.01" name="monto" id="id_monto_{{ t.id }}" class="form-control">
                </div>

                <!-- Campo tipo -->
                <div class="mb-3">
                  <label for="id_tipo_{{ t.id }}" class="form-label">Tipo</label>
                  <select name="tipo" id="id_tipo_{{ t.id }}" class="form-select">
                    {% for val, label in movimiento_form.fields.tipo.choices %}
                      <option value="{{ val }}">{{ label }}</option>
                    {% endfor %}
                  </select>
                </div>
              </div>

              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                <button type="submit" name="agregar_movimiento" class="btn btn-primary">Guardar Movimiento</button>
              </div>
            </form>
          </div>
        </div>
      </div>

    </li>
    {% endfor %}
  </ul>
</div>
{% endblock %}
